<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>国産第1号</title>
  <style>
    /* リセット・ベース設定 */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Segoe UI', sans-serif; background: #36393f; color: #fff; }
    .neon { color: #00ff7f; text-shadow: 0 0 5px #00ff7f, 0 0 10px #00ff7f, 0 0 20px #00ff7f; }
    /* ロード画面 */
    #loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #23272a; display: flex; align-items: center; justify-content: center;
      z-index: 1000; flex-direction: column;
    }
    #loading .loader {
      border: 8px solid rgba(255,255,255,0.1);
      border-top: 8px solid #00ff7f;
      border-radius: 50%; width: 60px; height: 60px;
      animation: spin 1s linear infinite; margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* Discord風のレイアウト */
    .app-container { display: flex; height: 100%; }
    .sidebar {
      width: 250px; background: #2f3136; padding: 10px; display: flex;
      flex-direction: column;
    }
    .chat-container {
      flex: 1; display: flex; flex-direction: column; background: #36393f;
    }
    .sidebar h2, .chat-container h2 { margin-bottom: 10px; font-size: 18px; }
    .sidebar section { margin-bottom: 20px; }
    .sidebar input, .chat-container input {
      width: 100%; padding: 8px; margin-bottom: 8px; border: none;
      border-radius: 4px; background: #40444b; color: #fff;
    }
    .sidebar button, .chat-container button {
      width: 100%; padding: 8px; border: none; border-radius: 4px;
      background: #7289da; color: #fff; cursor: pointer; transition: background 0.2s;
    }
    .sidebar button:hover, .chat-container button:hover {
      background: #677bc4;
    }
    .friend-list { list-style: none; }
    .friend-item {
      padding: 8px; margin-bottom: 4px; background: #40444b;
      border-radius: 4px; cursor: pointer; transition: background 0.2s;
    }
    .friend-item:hover { background: #4f545c; }
    .messages { flex: 1; overflow-y: auto; padding: 10px; }
    .message { margin-bottom: 10px; }
    .message strong { margin-right: 5px; }
    .chat-input {
      display: flex; padding: 10px; border-top: 1px solid #40444b;
    }
    .chat-input input {
      flex: 1; padding: 8px; border: none; border-radius: 4px;
      background: #40444b; color: #fff;
    }
    .chat-input button {
      margin-left: 10px; padding: 8px 16px; border: none; border-radius: 4px;
      background: #7289da; color: #fff; cursor: pointer; transition: background 0.2s;
    }
    .chat-input button:hover { background: #677bc4; }
  </style>
</head>
<body>
  <!-- ロード画面 -->
  <div id="loading">
    <div class="loader"></div>
    <div class="neon">Loading...</div>
  </div>
  <!-- メインアプリ（初回は非表示、ロード完了後に表示） -->
  <div class="app-container" id="app" style="display: none;">
    <!-- サイドバー -->
    <div class="sidebar">
      <h2 class="neon">国産第1号</h2>
      <!-- ユーザー登録エリア -->
      <section id="register-section">
        <h3>登録</h3>
        <input type="text" id="reg-username" placeholder="ユーザー名">
        <button id="register-btn">登録する</button>
      </section>
      <!-- 登録済みの場合のユーザーエリア -->
      <section id="user-section" style="display:none;">
        <h3>ようこそ, <span id="current-user"></span></h3>
        <!-- ユーザー検索 -->
        <section>
          <h4>ユーザー検索</h4>
          <input type="text" id="search-query" placeholder="検索...">
          <button id="search-btn">検索</button>
          <ul id="search-results"></ul>
        </section>
        <!-- フレンドリスト -->
        <section>
          <h4>フレンドリスト</h4>
          <ul id="friend-list" class="friend-list"></ul>
        </section>
      </section>
    </div>
    <!-- チャットコンテナ -->
    <div class="chat-container">
      <div class="messages" id="messages">
        <h2 class="neon">チャットを選択してください</h2>
      </div>
      <div class="chat-input" id="chat-input" style="display: none;">
        <input type="text" id="chat-message" placeholder="メッセージを入力...">
        <button id="send-btn">送信</button>
      </div>
    </div>
  </div>
  <script>
    let currentUser = null;
    let currentFriend = null;
    
    window.addEventListener('load', () => {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      // 既に登録済みならlocalStorageから取得
      const storedUser = localStorage.getItem('username');
      if (storedUser) {
        currentUser = storedUser;
        showUserSection();
        loadFriends();
      }
    });
    
    function showUserSection() {
      document.getElementById('register-section').style.display = 'none';
      document.getElementById('user-section').style.display = 'block';
      document.getElementById('current-user').innerText = currentUser;
    }
    
    document.getElementById('register-btn').addEventListener('click', async () => {
      const username = document.getElementById('reg-username').value.trim();
      if (!username) return;
      try {
        const res = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        const data = await res.json();
        if (res.ok) {
          currentUser = data.username;
          localStorage.setItem('username', currentUser);
          showUserSection();
          loadFriends();
        } else {
          alert(data.error || '登録失敗');
        }
      } catch (e) {
        console.error(e);
      }
    });
    
    document.getElementById('search-btn').addEventListener('click', async () => {
      const query = document.getElementById('search-query').value.trim();
      if (!query) return;
      try {
        const res = await fetch('/api/users/search?query=' + encodeURIComponent(query));
        const users = await res.json();
        const resultsEl = document.getElementById('search-results');
        resultsEl.innerHTML = '';
        users.forEach(user => {
          // 自分自身や既にフレンドなら表示しない
          if (user.username === currentUser) return;
          const li = document.createElement('li');
          li.className = 'friend-item';
          li.innerText = user.username;
          li.addEventListener('click', () => {
            addFriend(user.username);
          });
          resultsEl.appendChild(li);
        });
      } catch (e) {
        console.error(e);
      }
    });
    
    async function addFriend(friendUsername) {
      try {
        const res = await fetch('/api/friends', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ from: currentUser, to: friendUsername })
        });
        const data = await res.json();
        if (res.ok) {
          alert('フレンド追加成功: ' + friendUsername);
          loadFriends();
        } else {
          alert(data.error || 'フレンド追加失敗');
        }
      } catch (e) {
        console.error(e);
      }
    }
    
    async function loadFriends() {
      try {
        const res = await fetch('/api/friends?username=' + encodeURIComponent(currentUser));
        const data = await res.json();
        const friendListEl = document.getElementById('friend-list');
        friendListEl.innerHTML = '';
        data.friends.forEach(friend => {
          const li = document.createElement('li');
          li.className = 'friend-item';
          li.innerText = friend;
          li.addEventListener('click', () => {
            selectFriend(friend);
          });
          friendListEl.appendChild(li);
        });
      } catch (e) {
        console.error(e);
      }
    }
    
    function selectFriend(friend) {
      currentFriend = friend;
      document.getElementById('messages').innerHTML = '';
      document.getElementById('chat-input').style.display = 'flex';
      loadMessages();
    }
    
    async function loadMessages() {
      if (!currentFriend) return;
      try {
        const res = await fetch(`/api/messages?from=${encodeURIComponent(currentUser)}&to=${encodeURIComponent(currentFriend)}`);
        const messages = await res.json();
        const messagesEl = document.getElementById('messages');
        messagesEl.innerHTML = '';
        messages.forEach(msg => {
          const div = document.createElement('div');
          div.className = 'message';
          div.innerHTML = `<strong>${msg.from}:</strong> ${msg.message}`;
          messagesEl.appendChild(div);
        });
      } catch (e) {
        console.error(e);
      }
    }
    
    document.getElementById('send-btn').addEventListener('click', async () => {
      const messageInput = document.getElementById('chat-message');
      const text = messageInput.value.trim();
      if (!text || !currentFriend) return;
      try {
        const res = await fetch('/api/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ from: currentUser, to: currentFriend, message: text })
        });
        const data = await res.json();
        if (res.ok) {
          messageInput.value = '';
          loadMessages();
        } else {
          alert(data.error || '送信失敗');
        }
      } catch (e) {
        console.error(e);
      }
    });
    
    // 定期的にメッセージをポーリング（3秒ごと）
    setInterval(loadMessages, 3000);
  </script>
</body>
</html>
